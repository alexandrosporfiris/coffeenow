var currentUrl = window.location.href;

// fix language redirect url, which cannot work correctly because of base meta tag
function languageUri(param){
	
	// remove any query params
	if ( currentUrl.indexOf("?") ) {
		let urlParts = currentUrl.split("?");
		currentUrl = urlParts[0];
	}
	
	// check for slash at the end and remove it
	if (currentUrl.charAt(currentUrl.length - 1) == "/") 
		currentUrl = currentUrl.substr(0, currentUrl.length - 1);
	
	// add clicked link href to final url
	currentUrl = currentUrl + param;
	
	window.location = currentUrl;
	
}

// function to ask user yes or no for a destructive action
function yesNo(elem, container, url){
	$(elem).closest(container).append('<form id="yesNoFormCFN" action="'+url+'">'+language_JSON[locale]["areYouSure"]+'<button class="btn btn-success btn-sm yes"><span class="text-white-50">'+language_JSON[locale]["yes"]+'</span></button><button class="btn btn-danger btn-sm no"><span class="text-white-50">'+language_JSON[locale]["no"]+'</span></button></form>');
}

$(document).ready(function() {
	
	// handling yes click of a yesNoFormCFN, generated by function yesNo
	$(document).on("click", "#yesNoFormCFN .yes", function(e){
		$("#yesNoFormCFN").submit();
	});
	
	// handling no click of a yesNoFormCFN, generated by function yesNo
	$(document).on("click", "#yesNoFormCFN .no", function(e){
		$("#yesNoFormCFN").remove();
	});
	
	// productcategories DATATABLE	
	var table = $('.dataTableCFN').DataTable({
		orderFixed: [1, 'asc'],
		select: {
			style: 'single'
		},
		info: false,
		responsive: true,
        rowGroup: {
			startRender: function ( rows, group ) {
				var title = rows
					.data()
					.pluck(2);
					console.log(title);
				return $('<tr/>')
                    .append( '<td colspan="4">'+group+' - '+title+'</td>' );
			},
			endRender: null,
            dataSrc: 1
        },
		columnDefs: [
			{ responsivePriority: 1, targets: "titleHeaderCFN" }
		]
	});
	
	// ON DATATABLE ROW SELECT
	table.on( 'select', function( event, data, type, indexes ) {
		event.preventDefault;
		let selectedRow = table[ type ]( indexes ).nodes().to$();
		selectedRow.find(".optionsCFN").html('<form><button type="button" onclick="yesNo(this, \'.optionsCFN\', \'administrator/dashboard/productcategories/delete/'+ selectedRow.find(".rowIdCFN").html() +'\')" class="btn btn-danger btn-sm"><span class="icon text-white-50"><i class="fas fa-trash"></i></span></button></form>');
	});
	
	// ON DATATABLE ROW DESELECT
	table.on( 'deselect', function( event, data, type, indexes ) {
		event.preventDefault;
		table[ type ]( indexes ).nodes().to$().children().last().html('');
	});
	
	// injecting logout form on click
	$(document).on("click", "#userMenuCNF", function(){
		$("#logoutModal").find(".modal-content").html('<div class="modal-header"><h5 class="modal-title" id="logoutModalLabel">'+ language_JSON[locale]["logoutAsk"] +'</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button></div><div class="modal-body">'+ language_JSON[locale]["logoutInfo"] +'</div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">'+ language_JSON[locale]["cancel"] +'</button><a class="btn btn-primary" href="administrator/dashboard/logout">'+ language_JSON[locale]["logout"] +'</a></div>');
	});
	
});
