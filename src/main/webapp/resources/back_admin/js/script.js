var currentUrl = window.location.href;

// main modal for messages
var mainModal = $("#logoutModal");

// add new category hidden form
var addCategoryForm = $("#newCategoryFormCFN");

// edit buttons for datatables
var editButton = $("#editMainTableRowCFN"),
	deleteButton = $("#deleteMainTableRowCFN"),
	newButton = $("#addMainTableRowCFN"),
	addRemoveButton = $("#addRemoveMainTableRowCFN");

// fix language redirect url, which cannot work correctly because of base meta tag
function languageUri(param){
	
	// remove any query params
	if ( currentUrl.indexOf("?") ) {
		let urlParts = currentUrl.split("?");
		currentUrl = urlParts[0];
	}
	
	// check for slash at the end and remove it
	if (currentUrl.charAt(currentUrl.length - 1) == "/") 
		currentUrl = currentUrl.substr(0, currentUrl.length - 1);
	
	// add clicked link href to final url
	currentUrl = currentUrl + param;
	
	window.location = currentUrl;
	
}

// function to ask user yes or no with a modal for an action
function yesNo(
	yesUrl, 
	openModal = false, 
	headerMessage = "", 
	bodyMessage = language_JSON[locale]["areYouSure"], 
	yesButtonText = language_JSON[locale]["yes"], 
	noButtonText = language_JSON[locale]["no"]
)
{
	mainModal.find(".modal-content")
	.html(
		'<div class="modal-header"><h5 class="modal-title" id="logoutModalLabel">'
		+ headerMessage +
		'</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button></div><div class="modal-body">'
		+ bodyMessage +
		'</div><div class="modal-footer"><form id="yesNoFormCFN" action="'
		+ yesUrl +
		'"><button type="button" class="btn btn-secondary no"><span class="text-white">'
		+ noButtonText +
		'</span></button><button type="button" class="btn btn-primary yes"><span class="text-white">'
		+ yesButtonText +
		'</span></button></form></div>'
	);
	if ( openModal ) mainModal.modal('show');
}
// handling yes click of a yesNoFormCFN, generated by function yesNo
$(document).on("click", "#yesNoFormCFN .yes", function(e){
	$("#yesNoFormCFN").submit();
});
// handling no click of a yesNoFormCFN, generated by function yesNo
$(document).on("click", "#yesNoFormCFN .no", function(e){
	mainModal.modal('hide');
	$("#yesNoFormCFN").remove();
});

// injecting logout form in modal on click
$(document).on("click", "#userMenuLogoutCNF", function(e){
	
	e.preventDefault;
	yesNo(
		$(this).attr("href"), 
		false, 
		language_JSON[locale]["logoutAsk"],
		language_JSON[locale]["logoutInfo"],
		language_JSON[locale]["logout"],
		language_JSON[locale]["cancel"]
	)
	
});

// handling form injection for new category button click
newButton.on("click", function(){
	addCategoryForm.removeClass("hidden");
});

$(document).ready(function() {
	
	// productcategories/extrascategories DATATABLE	needs specific order of columns :
	// 1. id 
	// 2. parent id
	// 3. title
	// anything else after that
	var table = $('#mainTableCFN').DataTable({
		orderFixed: [1, 'asc'],
		select: {
			style: 'single'
		},
		info: false,
		responsive: true,
        rowGroup: {
			startRender: function ( rows, group ) {
				var ids = rows.data().pluck(0);
				var titles = rows.data().pluck(2);
				var title = "";
				var i = rows.data().length;
				for(i; i >= 0; i-- ){
					if( ids[i] == group ) title = titles[i];
				}
				return $('<tr/>')
                    .append( '<td colspan="'+rows.columns().count()+'">'+group+' - '+title+'</td>' );
			},
			endRender: null,
            dataSrc: 1
        },
		columnDefs: [
			{ 
				responsivePriority: 1, 
				targets: "titleHeaderCFN" ,
				
			},
			{
				"targets": [ 1 ],
				"visible": false,
				"searchable": false
			}
		]
	});
	
	// ON DATATABLE ROW SELECT
	table.on( 'select', function( event, data, type, indexes ) {
		
		let selectedRow = table[ type ]( indexes ).nodes().to$();
		
		addCategoryForm.addClass("hidden");
		
		editButton.removeAttr("disabled");
		editButton.attr("onclick","");
		
		deleteButton.removeAttr("disabled");
		deleteButton.attr("onclick", "yesNo('administrator/dashboard/productcategories/delete/"+ selectedRow.find(".rowIdCFN").html() +"', true, '"+language_JSON[locale]["deleteInform"]+"')");
		
		addRemoveButton.removeAttr("disabled");
		
	});
	
	// ON DATATABLE ROW DESELECT
	table.on( 'deselect', function( event, data, type, indexes ) {
		
		addCategoryForm.addClass("hidden");
		
		editButton.attr("disabled","");
		editButton.removeAttr("onclick");
		
		deleteButton.attr("disabled","");
		deleteButton.removeAttr("onclick");
		
		addRemoveButton.attr("disabled","");
		
	});
	
});
